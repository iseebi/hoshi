# hoshiファイルフォーマット Version 0.3 (Draft)

hoshiは、シンプルな仕組みで翻訳文言を管理するソフトウェアです。
この文章では、hoshiで扱われるデータのフォーマットについて記載します。

## 設計の方針

hoshiは、シンプルな管理アプローチを採用し、多くのワークフローに適合すことを目標としています。
このため、平易な構造を一般的なファイルフォーマットで定義し、一般的なテキストエディタや平易なスクリプティングにより処理ができるようにフォーマットを設計しています。

一方で、様々なワークフローに対応するために、拡張データを記載できる仕組みを設けています。
この拡張データは標準動作のオーバーライドでも使用されますが、利用者が独自の値を定義して各自のワークフローに合わせたツールを作成するために利用することもできます。

## データ構造

hoshiフォーマットのデータは、以下の構造で構成されます。

- プロジェクト: プロジェクトは複数のパッケージを含み、グルーピングするオブジェクトです。パッケージ間で共通のデータを定義します。パッケージのディレクトリとproject.hoshiファイルで構成されるディレクトリとして保存される。
- パッケージ: 1つの翻訳ファイルの管理単位。出力される1つの文言データセットに対して1つ定義される。パッケージに含まれるすべてのバージョンファイルとpackage.hoshiファイルを格納したディレクトリとして保存される。
- バージョン: パッケージ内の変更記録の単位。ファイル名順に順番に適用された結果が出力結果となる。単純なYAMLファイルとして保存される。
- フレーズ: バージョン内に定義されている1つの文言。キーと各言語の値で構成される。バージョンファイル内の1つのキーとして保存される。

例えば、サーバーとアプリの文言を管理する、SomeServiceプロジェクトのデータは以下のファイル構成になります。

```
SomeService/
  - project.hoshi
  - app/
      - package.hoshi
      - 00000000_initial.yaml
      - 00001000_add_some_feature.yaml
  - server/
      - package.hoshi
      - 00000000_initial.yaml
      - 00001000_add_some_feature.yaml
```

### メタデータ

プロジェクト・パッケージ・バージョン・フレーズの各要素にはメタデータを付与するできます。
YAMLファイルで表現されているものについては各YAMLファイルのmetadataキー、フレーズの場合は `$` からはじまるキーがメタデータとなります。

メタデータはこの仕様の各セクションで定義されている標準メタデータと、利用者が自由に定義するメタデータがあり、両者を混在して記述できます。

メタデータのキーとして使用できる文字は英数字と `_` `.` `-` です。 ケーシングについては利用者が決定できますが、lowerCamelCaseを推奨します。
今後の仕様で標準キーが増える可能性があるため、衝突を防ぐために、任意の文字列+`.`をプレフィクスとすることを推奨します。ただし、以下のプレフィクスは予約語として使用できないものとします。

- `hoshi.`
- `system.`
- `std.`

メタデータの値はYAMLの基本的なデータ型を使用可能ですが、フレーズの場合は文字列以外の値を定義することはできません。

すべての標準キーメタデータはオプショナルです。指定されない場合は無視されるか、定義されているデフォルト値で動作します。
標準キーはより詳細のコンテキストで定義されたものが優先的に使用され、コマンドラインオプション等動作時上書き指定があれば、その値が優先されます。例えば同じ標準キーでプロジェクトとフレーズで定義されている値があれば、フレーズに定義されているものが優先して使用されます。

## YAMLファイルのフォーマット

hoshi で扱われるYAMLファイルは、YAML 1.2をベースとし、必ずルートに `type` キーを持ちます。hoshiのアプリケーションは、`type`キーを使ってそのファイルが意図したファイルであるかを確認します。プロジェクトとパッケージを表すファイルは拡張子をhoshiとし、バージョンファイルでは拡張子をyamlとします。(通常の作業フローではプロジェクト・パッケージファイルを直接編集するのは限られたタイミングだが、バージョンファイルはhoshi Editor以外の一般的なテキストエディタの関連付けで開けるようにするため)

以下にファイル名とtypeキーの値の対応をまとめます。

| ファイル種別 | ファイル名         | type            |
|--------|---------------|-----------------|
| プロジェクト | project.hoshi | hoshi.project:1 |
| パッケージ  | package.hoshi | hoshi.package:1 |
| バージョン  | *.yaml        | hoshi.version:1 |

## プロジェクト

プロジェクトは複数のパッケージを含み、グルーピングするオブジェクトです。パッケージ間で共通のデータを定義します。
プロジェクトはディレクトリとして保存され、このディレクトリの中にはプロジェクトに含まれるパッケージのディレクトリとproject.hoshiファイルが保存されています。

### project.hoshi ファイル

project.hoshiファイルには、以下のキーが定義されます。

| キー       | 型          | Required | 説明                                                     |
|----------|------------|----------|--------------------------------------------------------|
| type     | string     | *        | ファイル種別を検出するためのヘッダ。必ず `hoshi.project:1` を指定する。          |
| id       | string     | *        | プロジェクトのID。逆ドメイン形式 (ex: com.example.someservice) を推奨する。 |
| metadata | dictionary | *        | プロジェクトに定義されるメタデータ                                      |

### メタデータ

プロジェクトレベルで定義される標準メタデータとして、以下のものがあります。

| キー            | 型        | デフォルト値 | 説明                                          |
|---------------|----------|--------|---------------------------------------------|
| contextPrefix | string   | ""     | コンテキストを出力するフレーズに付与されるプレフィクス。定義がない場合は出力されない。 |
| formats       | string[] | []     | 出力するファイルフォーマット。定義がない場合は対応する形式すべてを出力する。      |

## パッケージ

パッケージは1つの翻訳ファイルの管理単位です。出力される1つの文言データセットに対して1つ定義される。これは、1つのパッケージから、対応する言語に対して1ファイルが生成されると捉えられます。
パッケージはディレクトリとして保存され、含まれるすべてのバージョンファイルとpackage.hoshiファイルを格納したディレクトリとして保存されます。

### package.hoshi ファイル

package.hoshiファイルには、以下のキーが定義されます。

| キー       | 型          | Required | 説明                                            |
|----------|------------|----------|-----------------------------------------------|
| type     | string     | *        | ファイル種別を検出するためのヘッダ。必ず `hoshi.package:1` を指定する。 |
| metadata | dictionary | *        | プロジェクトに定義されるメタデータ                             |

### メタデータ

パッケージレベルで定義される標準メタデータとして、以下のものがあります。

| キー                    | 型        | デフォルト値 | 説明                                                                      |
|-----------------------|----------|--------|-------------------------------------------------------------------------|
| contextPrefix         | string   | ""     | コンテキストを出力するフレーズに付与されるプレフィクス。定義がない場合は出力されない。                             |
| formats               | string[] | []     | 出力するファイルフォーマット。定義がない場合は対応する形式すべてを出力する。                                  |
| availableTranslations | string[] | []     | 対応する言語。ここに定義があって項目がない場合は空のファイルが出力される。定義がない場合はバージョンファイルをマージした結果から推測されます。 |

## バージョン

バージョンはパッケージ内の変更記録の単位です。1つのファイルが1つの変更記録となり、パッケージ内でファイル名の昇順で並べた順に含まれているフレーズをマージしていき最終的な出力を得ます。
実際の変換作業では目的に応じて、すべてのバージョンファイルを読み取るか、特定のバージョンファイルを指定してそのバージョンまでの内容をスナップショットとして出力するかを選択することになります。

### バージョンファイル

バージョンファイルには、以下のキーが定義されます。

| キー       | 型          | Required | 説明                                            |
|----------|------------|----------|-----------------------------------------------|
| type     | string     | *        | ファイル種別を検出するためのヘッダ。必ず `hoshi.version:1` を指定する。 |
| metadata | dictionary |          | バージョンに定義されるメタデータ                              |
| phrases  | dictionary |          | 定義されるフレーズ                                     |

### メタデータ

バージョンレベルで定義される標準メタデータとして、以下のものがあります。

| キー          | 型      | デフォルト値 | 説明        |
|-------------|--------|--------|-----------|
| description | string | ""     | バージョンの説明。 |

## フレーズ

フレーズは翻訳文言の単位であり、メタデータと言語ごとのテキストから構成されます。バージョンファイルのphrasesキーの要素として定義されます。

もし、当該のバージョンで定義されていない言語があったとしても、ほかのバージョンで定義されている場合はその言語のテキストが使用されます。

### キー

フレーズのキー(バージョンファイルphrasesキー)として使用できる文字は英数字と `_` `.` `-` です。

ケーシングについては利用者が決めることができますが、lowerCamelCaseを推奨します。

### 言語

言語のテキストは、ISO 639-1に準拠した2文字の言語コードをキーとして、その言語のテキストを値として持ちます。

### メタデータ

フレーズレベルのメタデータは、フレーズのキーに対して `$` からはじまるキーとして定義されます。フレーズレベルのメタデータでは、文字列以外の値を定義することはできません。

フレーズレベルの標準メタデータとして、以下のものがあります。

| キー                    | 型        | デフォルト値 | 説明                                                          |
|-----------------------|----------|--------|-------------------------------------------------------------|
| deleted               | string   | ""     | "true"を記載することで、当該のバージョンで文言が削除されたことを示す。bool値ではなく、文字列で記載すること。 |

### 文言のテキスト

文言のテキストはJavaのString.formatの形式が記述されていることを想定して動作します。変換時に、変換先フォーマットにあわせてJavaのString.formatから最も近い形式に変換されます。
ただし、抽象表現であることから完全な一致を得ることは困難です。そのため、複雑な変換を要する場合は文字列のプレースホルダを定義しておき、利用側で適切なフォーマットした文字列を使用することを検討してください。

記載の簡易化のため、数値やboolean値が記載された場合も、一度文字列に変換して処理されます。
